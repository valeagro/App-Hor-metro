<!DOCTYPE html>
<html lang="pt-br" class="bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hor√≠metro Pro</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hor√≠metro Pro">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <div id="toast" class="fixed top-5 right-5 z-50 transform transition-all duration-300 translate-x-full opacity-0">
        <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl flex items-center space-x-2">
            <i data-lucide="info" class="w-5 h-5 text-blue-400" id="toast-icon"></i>
            <span id="toast-message">Notifica√ß√£o</span>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 items-center justify-center hidden px-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <div class="flex items-center">
                <div class="mr-3 flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Confirmar Exclus√£o</h3>
            </div>
            <p class="text-sm text-gray-600 mt-4">Tem certeza que deseja excluir este registro? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Excluir</button>
            </div>
        </div>
    </div>

    <div class="min-h-screen flex flex-col">
        <header class="bg-white shadow-sm z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i data-lucide="gauge" class="w-6 h-6 text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900">Hor√≠metro Pro</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="auth-status" class="text-sm text-gray-500 flex items-center">
                        <i data-lucide="circle-dot" class="w-3 h-3 text-yellow-500 mr-2 animate-pulse" id="status-icon"></i>
                        <span id="status-text">Conectando...</span>
                    </span>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
                        <h2 class="font-semibold text-gray-800 flex items-center">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-blue-600"></i>
                            Novo Registro
                        </h2>
                    </div>
                    <div class="p-6">
                        <form id="entry-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Data</label>
                                    <input type="date" id="date" required class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Turno</label>
                                    <select id="shift" required class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                        <option value="">Selecione</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Equipamento</label>
                                <select id="equipment" required class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <option value="">Selecione o equipamento</option>
                                </select>
                            </div>

                            <div class="pt-4 border-t border-gray-100">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 uppercase mb-1">H. Inicial (HH,MM)</label>
                                        <input type="text" id="start-hour" inputmode="decimal" placeholder="0000,00" required class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Horas Op. (HH,MM)</label>
                                        <input type="text" id="operated-hours" inputmode="decimal" placeholder="00,00" required class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 uppercase mb-1">Hor√≠metro Final (Autom√°tico)</label>
                                <div class="relative">
                                    <input type="text" id="end-hour" readonly class="w-full px-3 py-3 bg-blue-50 border border-blue-200 text-blue-800 font-bold rounded-lg font-mono text-lg">
                                    <i data-lucide="lock" class="w-4 h-4 text-blue-400 absolute top-4 right-3"></i>
                                </div>
                            </div>

                            <button type="submit" id="submit-btn" disabled class="w-full flex justify-center items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 text-white font-medium rounded-lg transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i>
                                Carregando...
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h2 class="font-semibold text-gray-800 flex items-center">
                            <i data-lucide="filter" class="w-5 h-5 mr-2 text-blue-600"></i>
                            Filtros & Relat√≥rios
                        </h2>
                         <button onclick="exportToWhatsApp()" class="flex items-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-medium rounded-lg transition-colors focus:ring-4 focus:ring-green-200">
                            <i data-lucide="message-circle" class="w-5 h-5 mr-2"></i>
                            Enviar Relat√≥rio (WhatsApp)
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Data Inicial</label>
                            <input type="date" id="filter-date-start" class="w-full text-sm px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Data Final</label>
                            <input type="date" id="filter-date-end" class="w-full text-sm px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Equipamento</label>
                            <select id="filter-equipment" class="w-full text-sm px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Turno</label>
                            <select id="filter-shift" class="w-full text-sm px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-[500px]">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center sticky top-0">
                        <h2 class="font-semibold text-gray-800 flex items-center">
                            <i data-lucide="list" class="w-5 h-5 mr-2 text-blue-600"></i>
                            Registros
                        </h2>
                        <span id="record-count" class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800">
                            0 registros
                        </span>
                    </div>
                    <div class="overflow-auto flex-1 no-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data / Turno</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipamento</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Inicial</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Operado</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Final</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Excluir</th>
                                </tr>
                            </thead>
                            <tbody id="logs-body" class="bg-white divide-y divide-gray-100">
                                <tr>
                                    <td colspan="6" class="px-6 py-10 text-center text-gray-400 flex flex-col items-center justify-center">
                                        <i data-lucide="inbox" class="w-10 h-10 mb-2 opacity-50"></i>
                                        <span>Aguardando dados...</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Importa√ß√µes din√¢micas
        let initializeApp, getAuth, signInAnonymously, onAuthStateChanged;
        let getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, onSnapshot, limit, orderBy;

        // --- REGISTRO DO SERVICE WORKER (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado!', reg.scope))
                    .catch(err => console.log('Falha ao registrar SW:', err));
            });
        }

        // =================================================================
        // ‚ö†Ô∏è ATEN√á√ÉO: SUBSTITUA COM SUAS CREDENCIAIS DO FIREBASE AQUI! ‚ö†Ô∏è
        // =================================================================
        const FIREBASE_CONFIG = {
            apiKey: "SUA_API_KEY_AQUI",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_PROJECT_ID.appspot.com",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };
        // =================================================================

        const EQUIPMENTS = ["100018", "100019", "100020", "100021", "100022"];
        const SHIFTS = ["1¬∫", "2¬∫", "3¬∫"];
        
        let app, auth, db, userId;
        let dbInitialized = false;
        let allLogs = [];
        let filteredLogs = [];
        let docToDelete = null;
        const els = {}; 

        // --- FUN√á√ïES AUXILIARES ---
        function parseTimeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const str = String(timeStr).replace(',', '.').replace(/[^0-9.]/g, '');
            const parts = str.split('.');
            const hours = parseInt(parts[0], 10) || 0;
            const minutes = parseInt(parts[1], 10) || 0;
            return (hours * 60) + minutes;
        }
        function formatMinutesToTime(totalMinutes) {
            if (isNaN(totalMinutes)) totalMinutes = 0;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours},${String(minutes).padStart(2, '0')}`;
        }
        function displayTime(value) {
             const num = parseFloat(value) || 0;
             return (Number.isInteger(num) && num > 5000) ? formatMinutesToTime(num) : formatMinutesToTime(Math.round(num * 60));
        }
        function formatDateBR(dateStr) {
            if (!dateStr) return '-';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y.slice(2)}`;
        }
        function showToast(msg, type = 'info') {
            if (!els.toastMsg) return;
            els.toastMsg.textContent = msg;
            els.toast.classList.remove('translate-x-full', 'opacity-0');
            els.toast.className = `fixed top-5 right-5 z-50 transform transition-all duration-300 ${type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-green-600' : 'bg-gray-800')} text-white px-6 py-3 rounded-lg shadow-xl flex items-center space-x-2`;
            if (window.lucide) window.lucide.createIcons();
            setTimeout(() => { if (els.toast) els.toast.classList.add('translate-x-full', 'opacity-0'); }, 3000);
        }
        function updateStatus(connected) {
            if (!els.statusIcon) return;
            if (connected) {
                els.statusIcon.className = 'w-3 h-3 mr-2 text-green-500';
                els.statusText.textContent = 'Conectado';
                if (els.submitBtn) {
                    els.submitBtn.disabled = false;
                    els.submitBtn.innerHTML = `<i data-lucide="save" class="w-5 h-5 mr-2"></i> Salvar Registro`;
                }
            } else {
                els.submitBtn.disabled = true;
                if (dbInitialized && !userId) {
                    els.statusIcon.className = 'w-3 h-3 mr-2 text-yellow-500 animate-pulse';
                    els.statusText.textContent = 'Conectando...';
                    els.submitBtn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i> Conectando...`;
                } else {
                    els.statusIcon.className = 'w-3 h-3 mr-2 text-gray-400';
                    els.statusText.textContent = 'Aguardando Config.';
                    els.submitBtn.innerHTML = `<i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i> Verifique Config`;
                }
            }
            if (window.lucide) window.lucide.createIcons();
        }

        // --- L√ìGICA DE NEG√ìCIO ---
        function calculateEnd() {
            if (!els.startHour || !els.operatedHours) return;
            const start = parseTimeToMinutes(els.startHour.value);
            const op = parseTimeToMinutes(els.operatedHours.value);
            els.endHour.value = formatMinutesToTime(start + op);
        }
        async function autoFillStartHour() {
            if (!dbInitialized || !userId || !els.date?.value || !els.equipment?.value || !els.shift?.value) return;
            const d = new Date(els.date.value + 'T12:00:00Z');
            let prevDateStr = els.date.value;
            let prevShiftStr = els.shift.value === '1¬∫' ? '3¬∫' : (els.shift.value === '2¬∫' ? '1¬∫' : '2¬∫');
            if (els.shift.value === '1¬∫') {
                 d.setUTCDate(d.getUTCDate() - 1);
                 prevDateStr = d.toISOString().split('T')[0];
            }
            const docId = `${els.equipment.value}-${prevDateStr}-${prevShiftStr}`;
            try {
                els.startHour.classList.add('opacity-50');
                const snap = await getDoc(doc(db, `horimeter_logs_v2`, docId));
                els.startHour.value = snap.exists() ? displayTime(snap.data().endMinutes) : '';
                if (snap.exists()) showToast('Hor√≠metro inicial vinculado!', 'success');
            } catch (e) { console.error("Erro ao buscar anterior:", e); } 
            finally {
                els.startHour.classList.remove('opacity-50');
                calculateEnd();
            }
        }
        function applyFilters() {
            if (!els.fDateStart) return;
            const start = els.fDateStart.value, end = els.fDateEnd.value, eq = els.fEquip.value, sh = els.fShift.value;
            filteredLogs = allLogs.filter(log => (!start || log.date >= start) && (!end || log.date <= end) && (eq === 'all' || log.equipment === eq) && (sh === 'all' || log.shift === sh));
            renderTable();
        }
        function renderTable() {
            if (!els.logsBody) return;
            els.recordCount.textContent = `${filteredLogs.length} registros`;
            if (filteredLogs.length === 0) {
                els.logsBody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500 flex flex-col items-center"><i data-lucide="inbox" class="w-8 h-8 mb-2 opacity-40"></i>Nenhum registro encontrado.</td></tr>`;
            } else {
                els.logsBody.innerHTML = filteredLogs.map(log => `
                    <tr class="hover:bg-blue-50/50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${formatDateBR(log.date)}</div><div class="text-xs text-gray-500">${log.shift} turno</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${log.equipment}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-mono">${displayTime(log.startMinutes)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-mono">${displayTime(log.opMinutes)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-right font-mono">${displayTime(log.endMinutes)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <button class="delete-btn p-2 rounded-full hover:bg-red-100 text-red-500 hover:text-red-700 transition-colors focus:outline-none" data-doc-id="${log.docId}" title="Excluir Registro">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>`).join('');
            }
            if (window.lucide) window.lucide.createIcons();
        }

        // --- FUN√á√ïES DO MODAL ---
        function openDeleteModal(docId) {
            docToDelete = docId;
            els.deleteModal.classList.remove('hidden');
            els.deleteModal.classList.add('flex');
            if (window.lucide) window.lucide.createIcons(); 
        }
        function closeDeleteModal() {
            docToDelete = null;
            els.deleteModal.classList.add('hidden');
            els.deleteModal.classList.remove('flex');
        }

        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
        async function init() {
            console.log("Iniciando app...");
            
            // 1. Capturar elementos do DOM (Mapeamento Seguro)
            els.entryForm = document.getElementById('entry-form');
            els.date = document.getElementById('date');
            els.equipment = document.getElementById('equipment');
            els.shift = document.getElementById('shift');
            els.startHour = document.getElementById('start-hour');
            els.operatedHours = document.getElementById('operated-hours');
            els.endHour = document.getElementById('end-hour');
            els.logsBody = document.getElementById('logs-body');
            els.recordCount = document.getElementById('record-count');
            els.statusIcon = document.getElementById('status-icon');
            els.statusText = document.getElementById('status-text');
            els.submitBtn = document.getElementById('submit-btn');
            els.toast = document.getElementById('toast');
            els.toastMsg = document.getElementById('toast-message');
            
            // Filtros (Mapeamento Expl√≠cito para evitar erros)
            els.fDateStart = document.getElementById('filter-date-start');
            els.fDateEnd = document.getElementById('filter-date-end');
            els.fEquip = document.getElementById('filter-equipment');
            els.fShift = document.getElementById('filter-shift');

            // Modal
            els.deleteModal = document.getElementById('delete-modal');
            els.modalCancelBtn = document.getElementById('modal-cancel-btn');
            els.modalConfirmBtn = document.getElementById('modal-confirm-btn');

            // 2. Popular menus (AGORA VAI!)
            // Verifica se os elementos existem antes de tentar popular
            if (els.equipment && els.fEquip) {
                console.log("Populando equipamentos...");
                EQUIPMENTS.forEach(eq => {
                    els.equipment.add(new Option(eq, eq));
                    els.fEquip.add(new Option(eq, eq));
                });
            } else { console.error("Erro: Menus de equipamento n√£o encontrados no HTML"); }

            if (els.shift && els.fShift) {
                console.log("Populando turnos...");
                SHIFTS.forEach(sh => {
                    els.shift.add(new Option(sh, sh));
                    els.fShift.add(new Option(sh, sh));
                });
            } else { console.error("Erro: Menus de turno n√£o encontrados no HTML"); }

            // 3. Configurar UI inicial e Eventos
            if (els.date) els.date.value = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            if (window.lucide) window.lucide.createIcons();

            [els.startHour, els.operatedHours].forEach(el => el?.addEventListener('input', calculateEnd));
            [els.date, els.equipment, els.shift].forEach(el => el?.addEventListener('change', autoFillStartHour));
            [els.fDateStart, els.fDateEnd, els.fEquip, els.fShift].forEach(el => el?.addEventListener('input', applyFilters));
            
            els.entryForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!dbInitialized || !userId) return showToast('Sem conex√£o com banco de dados.', 'error');
                els.submitBtn.disabled = true;
                els.submitBtn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i> Salvando...`;
                if (window.lucide) window.lucide.createIcons();
                try {
                    const data = { date: els.date.value, equipment: els.equipment.value, shift: els.shift.value, startMinutes: parseTimeToMinutes(els.startHour.value), opMinutes: parseTimeToMinutes(els.operatedHours.value), endMinutes: parseTimeToMinutes(els.endHour.value), createdAt: new Date().toISOString() };
                    await setDoc(doc(db, 'horimeter_logs_v2', `${data.equipment}-${data.date}-${data.shift}`), data);
                    showToast('Registro salvo!', 'success');
                    els.entryForm.reset();
                    els.date.value = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                } catch (error) { console.error(error); showToast('Erro ao salvar.', 'error'); } 
                finally { updateStatus(true); }
            });

            els.modalCancelBtn?.addEventListener('click', closeDeleteModal);
            els.modalConfirmBtn?.addEventListener('click', async () => {
                if (!docToDelete || !dbInitialized) return;
                try {
                    await deleteDoc(doc(db, 'horimeter_logs_v2', docToDelete));
                    showToast('Registro exclu√≠do com sucesso!', 'success');
                } catch (e) {
                    console.error("Erro ao excluir:", e);
                    showToast('Falha ao excluir o registro.', 'error');
                } finally {
                    closeDeleteModal();
                }
            });

            els.logsBody?.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const docId = deleteBtn.dataset.docId;
                    if (docId) openDeleteModal(docId);
                }
            });

            // 4. Iniciar Firebase (√öLTIMO PASSO)
            try {
                const appModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                initializeApp = appModule.initializeApp;
                const authModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                getAuth = authModule.getAuth; signInAnonymously = authModule.signInAnonymously; onAuthStateChanged = authModule.onAuthStateChanged;
                const firestoreModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                getFirestore = firestoreModule.getFirestore; doc = firestoreModule.doc; getDoc = firestoreModule.getDoc; setDoc = firestoreModule.setDoc; deleteDoc = firestoreModule.deleteDoc; collection = firestoreModule.collection; query = firestoreModule.query; onSnapshot = firestoreModule.onSnapshot; limit = firestoreModule.limit; orderBy = firestoreModule.orderBy;

                initFirebaseConnection();
            } catch (e) {
                console.error("Erro fatal ao carregar m√≥dulos Firebase:", e);
                updateStatus(false);
            }
        }

        function initFirebaseConnection() {
             try {
                if (FIREBASE_CONFIG.apiKey === "SUA_API_KEY_AQUI") throw new Error("Configura√ß√£o do Firebase pendente");

                app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                dbInitialized = true;
                
                onAuthStateChanged(auth, user => {
                    userId = user ? user.uid : null;
                    updateStatus(!!user);
                    
                    if (user) {
                        onSnapshot(query(collection(db, 'horimeter_logs_v2'), orderBy('createdAt', 'desc'), limit(200)), (snap) => {
                            allLogs = [];
                            snap.forEach(doc => {
                                allLogs.push({ 
                                    ...doc.data(), 
                                    docId: doc.id 
                                });
                            });
                            allLogs.sort((a, b) => {
                                if (b.date !== a.date) return b.date.localeCompare(a.date);
                                if (b.shift !== a.shift) return b.shift.localeCompare(a.shift);
                                return a.equipment.localeCompare(b.equipment);
                            });
                            applyFilters();
                        });
                    }
                });
                signInAnonymously(auth).catch(e => console.error("Auth failed:", e));
            } catch (e) {
                console.warn("Firebase n√£o inicializado:", e.message);
                dbInitialized = false;
                updateStatus(false);
                if (els.logsBody) els.logsBody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-gray-400">Aguardando configura√ß√£o do Firebase.<br>Edite o arquivo index.html.</td></tr>`;
            }
        }

        window.exportToWhatsApp = function() {
            if (filteredLogs.length === 0) return showToast('Filtre dados para exportar.', 'error');
            let msg = `*Relat√≥rio de Hor√≠metro*\nGerado em: ${new Date().toLocaleDateString('pt-BR')}\n\n`;
            filteredLogs.slice(0, 30).forEach(log => { msg += `üìÖ *${formatDateBR(log.date)}* - Turno: ${log.shift}\nüöú Equip: *${log.equipment}*\n‚è±Ô∏è Ini: ${displayTime(log.startMinutes)} | Op: ${displayTime(log.opMinutes)} | *Fim: ${displayTime(log.endMinutes)}*\n----------------\n`; });
            if (filteredLogs.length > 30) msg += `\n*(...mais ${filteredLogs.length - 30} registros)*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        };

        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init); } else { init(); }
    </script>
</body>
</html>
